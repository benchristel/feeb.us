<!DOCTYPE html>
<html>
  <head>
    <title>Oath Structure</title>
    <style type="text/css" rel="stylesheet">
      iframe {
        position: absolute;
        top: -1000px;
      }
    </style>
  </head>
  <body>
    <button id="pause">Pause</button>
    <button id="play">Play</button>

    <script src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      "use strict";

      class Player {
        constructor(options) {
          var player = this
          this.container = options.container
          this.playButton = options.play
          this.pauseButton = options.pause
          this.queue = options.queue

          var playerElementId = 'player-' + Player.instanceCount
          $('<div>').attr('id', playerElementId).appendTo($('body'))

          this.youtubePlayer = new YT.Player(
            playerElementId,
            {
              height: '390',
              width: '640',
              videoId: this.queue.current().getId(),
              events: {
                'onReady': function() { player.onReady() },
                'onStateChange': function(event) { player.onStateChange(event) }
              }
            }
          )

          this.playButton.show()
          this.pauseButton.hide()
        }

        onReady() {
          console.log('ready!')
          var player = this;

          this.playButton.click(function() {
            player.playButton.hide()
            player.pauseButton.show()
            player.youtubePlayer.playVideo()
          })

          this.pauseButton.click(function() {
            player.pauseButton.hide()
            player.playButton.show()
            player.youtubePlayer.pauseVideo()
          })
        }

        onStateChange(event) {
          console.log('changed to: '+event.data)
          if (event.data === YT.PlayerState.ENDED) {
            this.queue.advance()
            this.youtubePlayer.cueVideoById({videoId: this.queue.current().id})
            this.youtubePlayer.playVideo()
          }
        }
      }

      Player.instanceCount = 0;

      class VideoQueue {
        constructor() {
          this.currentIndex = 0;
          this.videos = []
        }

        add(video) {
          this.videos.push(video)
          return this
        }

        current() {
          var video = this.videos[this.currentIndex]
          if (!video) {
            video = new NullVideo()
          }
          return video
        }

        advance() {
          this.currentIndex++
          if (this.currentIndex >= this.videos.length) {
            this.currentIndex = -1
          }
        }
      }

      class Video {
        constructor(id) {
          this.id = id
        }

        getId() {
          return this.id
        }
      }

      class NullVideo extends Video {
        constructor() {
          super(null)
        }
      }

      var g = {}

      function onYouTubeIframeAPIReady() {
        var queue = new VideoQueue()
            .add(new Video('au3-hk-pXsM'))
            .add(new Video('HsUgZANvAbU'))

        g.player = new Player({
          container: $('body'),
          play: $('#play'),
          pause: $('#pause'),
          queue: queue
        });
      }
    </script>
  </body>
</html>
