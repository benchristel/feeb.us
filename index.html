<html>
<head>
<link rel="icon" type="image/x-icon" href="resources/favicon.ico">
<link href="resources/mock.css" rel="stylesheet"></link>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<link href="resources/perfect-scrollbar.min.css" rel="stylesheet">
</head>
<body ng-app="OathStructure" ng-controller="AppController" ng-keypress="keypress($event)">

<div id="player-chrome" ng-controller="PlayerController" >
    <div class="scrubber-fill" ></div>

    <div class="song-info" ng-show="currentSong" ng-cloak>
        <div class="cover-image"
             style="background-image: url('https://i.ytimg.com/vi/{{currentSong().youtubeImageId}}/mqdefault.jpg')">
        </div>
        <div class="song-title text">{{currentSong().title}}</div>
        <div class="artist-name text">{{currentSong().artist}}</div>
        <div class="album-name text">{{currentSong().album}}</div>
    </div>

    <div class="player-controls" >
        <div style = "position:absolute;width:100%;height:100%;" ng-click = "seekTo($event)"></div>
        <div class="replay button fa fa-backward"></div>
        <div class="play button fa fa-play" ng-click="play()" ng-hide="playing()"></div>
        <div class="pause button fa fa-pause" ng-click="pause()" ng-show="playing()"></div>
        <div class="stop button fa fa-stop" ng-click="stop()"></div>
        <div class="skip button fa fa-forward" ng-click="forward()"></div>

    </div>
</div>

<div id="playlist-manager">
    <div id="queue-container" ng-controller="QueueController">
        <div class="video-player" id="youtube-player-1"></div>
        <div class="video-player inactive" id="youtube-player-2"></div>

        <div class="queue-actions">
            <div class="action-button fa fa-random left" ng-click = "shuffle()" ng-class="{active: shuffled}"></div>
            <div class="action-button fa fa-repeat left" ng-click = "repeat()" ng-class="{active: repeatQueue}" ></div>
            <div class="action-button fa fa-trash right" ng-click = "deleteSelected()"></div>
            <!-- I know trash might be used for something else, but it's just for now. Not sure how you'll delete in the current UI -->
            <div class="action-button fa fa-upload right" ng-click = "importLibrary()"></div>
            <div class="action-button fa fa-save right"></div>
        </div>
        <perfect-scrollbar class="queue" wheel-propagation="false" wheel-speed="20" refresh-on-change="queue" ng-cloak>
            <div class="song" ng-repeat="song in queue track by $index" ng-class="{playing: song.playing, selected: song.selected}" ng-click = "toggleSelect(song)">
                <div class="cover-image"
                     style="background-image: url('https://i.ytimg.com/vi/{{ song.youtubeImageId }}/mqdefault.jpg')">
                </div>
                <div class="fa fa-play-circle-o play-button" ng-click="jumpTo(song)"></div>
                <div class="song-title text">{{ song.title }}</div>
                <div class="artist-name text">{{ song.artist }}</div>
            </div>
        </perfect-scrollbar>
    </div>

    <div class="library-container" ng-controller="LibraryController" ng-cloak>
        <input id = "searchbar" type="text" class="search" placeholder="Search {{library.length}} songs" ng-model="searchQuery">

        <div class="library">
            <div class="header">
                <span class="track-number">&nbsp;</span>
                <span class="title">Title</span>
                <span class="artist">Artist</span>
                <span class="album">Album</span>
            </div>
            <perfect-scrollbar class="body" wheel-propagation="false" wheel-speed="20" refresh-on-change="searchQuery" scroll-up="true">
              <div>
                <div class="song" ng-repeat="song in library | filter:searchQuery">
                    <span class="track-number">{{ song.trackNumber }}</span>
                    <span class="add-button fa fa-plus" ng-click="addToQueue(song)"></span>
                    <span class="title">{{ song.title }}</span>
                    <span class="artist">{{ song.artist }}</span>
                    <span class="album">{{ song.album }}</span>
                </div>
              </div>

              <div class="import" ng-show="library.length > 0">
                Can't find what you're looking for? <div class="button" ng-click="startImport()">Import a Library</div>.
              </div>

              <div class="import" ng-show="library.length == 0">
                You don't have any songs in your library yet! <div class="button" ng-click="startImport()">Import a Library</div>.
              </div>
            </perfect-scrollbar>
        </div>
    </div>
</div>

<div class="import-modal" ng-show="importing" ng-cloak>
  <div>
    <textarea ng-model="importText"></textarea>
    <div class="button-container">
      <div class="button" ng-click="importFrom(importText)">Import</div>
      <div class="button" ng-click="cancelImport()">Cancel</div>
    </div>
  </div>
</div>

<script src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
<script src="//cdn.jsdelivr.net/underscorejs/1.8.3/underscore-min.js" type="text/javascript"></script>
<script src="resources/angular.min.js" type="text/javascript"></script>
<script src="resources/perfect-scrollbar.with-mousewheel.min.js" type="text/javascript"></script>
<script src="resources/angular-perfect-scrollbar.js" type="text/javascript"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="resources/message.js"></script>
<script src="resources/library_importer.js"></script>
<script src="resources/app.js"></script>
<script src="resources/deejay-service.js"></script>
<script src="resources/linked_list.js"></script>

<script type="text/javascript">
"use strict";

function parseLibrary(text) {
  text = removeComments(text)

  var album, artist, art, songs = []
  var anyWhitespaceContainingAtLeastTwoNewlines = /\n\s*\n\s*/
  var anythingFollowingAHashSymbol = /#[^\n]\n/g

  var sections = text.split(anyWhitespaceContainingAtLeastTwoNewlines)
  sections = sections.map(function(s) { return s.split(/\n/) })

  for (var section of sections) {
    if (section.length === 1) {
      artist = textFrom(section[0])
    } else {
      album = textFrom(section[0])
      art = youtubeIdFrom(section[0])

      for (var i = 1; i < section.length; i++) {
        songs.push({
          title: textFrom(section[i]),
          artist: artist,
          album: album,
          trackNumber: i,
          youtubeId: youtubeIdFrom(section[i]),
          youtubeImageId: art,
          selected: false,
          playing: false
        })
      }
    }
  }

  return songs

  function removeComments() {
    return text.replace(anythingFollowingAHashSymbol, "\n")
  }

  function textFrom(line) {
    return line.substring(11, line.length).trim()
  }

  function youtubeIdFrom(line) {
    return line.substring(0, 11)
  }
}

function onYouTubeIframeAPIReady() {
  message.send('youtube-iframe-api-ready')
}

var app = angular.module('OathStructure')

app.controller('LibraryController', function($scope) {
  $scope.addToQueue = function(song) {
    message.send('add-to-queue', angular.copy(song))
  }
})

app.controller('AppController', ['$scope','Deejay', function ($scope, Deejay) {
  $scope.searchQueryChars = function() {
    if (!$scope.searchQuery) return []
    return $scope.searchQuery.split('')
  }

  $scope.keypress = function(event){
    if (( document.activeElement !== null && document.activeElement.id !== "searchbar") || document.activeElement === null){
      if (event.which == 32){
        if (Deejay.getIsPlaying()){
          Deejay.pauseSong()
        }
        else{
          Deejay.playSong()
        }
      }
    }
  }

  message.on('import-library', function(song) {
    $scope.startImport()
  })

  $scope.startImport = function() {
    $scope.importing = true
  }

  $scope.importFrom = function(text) {
    $scope.library = parseLibrary(text || '')
    localStorage['oath-structure-library'] = text
    $scope.importing = false
  }

  $scope.cancelImport = function() {
    $scope.importing = false
  }

  $scope.importFrom(localStorage['oath-structure-library'])
}])

app.controller('QueueController', ['$scope','Deejay', function ($scope, Deejay) {
  $scope.queue = []
  $scope.shuffled = false;
  $scope.repeatQueue = false;
  $scope.normalQueue = []
  // $scope.shuffledQueue = []

  $scope.shuffle = function(){
    if ($scope.shuffled){
      $scope.queue = $scope.normalQueue
      $scope.shuffled = false
    }else{
      $scope.shuffled = true
      $scope.normalQueue = $scope.queue
      $scope.queue = _.shuffle($scope.queue)
    }
  }

  $scope.repeat = function(){
    if($scope.repeatQueue){
      $scope.repeatQueue = false
    } else{
      $scope.repeatQueue = true
    }
  }

  $scope.importLibrary = function(){
    message.send("import-library")
  }

  $scope.jumpTo = function(song) {
    var currentlyPlaying = currentlyPlayingIndex()
    if (currentlyPlaying !== null) {
      songAt(currentlyPlaying).playing = false
    }

    song.playing = true

    Deejay.setCurrentSong(song)
  }

  $scope.toggleSelect = function(song){
    if (song.selected){
      song.selected = false
    }else{
      song.selected = true
    }
  }

  $scope.deleteSelected = function(){
    _.each($scope.queue, function(song){
      if (song.selected){
        $scope.queue = _.without($scope.queue, _.findWhere($scope.queue, song));
      }
    })
  }

  // $scope.replay = function(){
  //   var song = Deejay.getCurrentSong()
  //   Deejay.stopSong()
  //   Deejay.setCurrentSong(song)
  // }

  message.on('deejay-needs-a-song', function() {
    var newSong = advance()
    if (!newSong) {
    }else{
      Deejay.setCurrentSong(newSong)
      $scope.$apply() // queue won't update properly otherwise...
    }
  })

  message.on('add-to-queue', function(song) {
    if ($scope.shuffled){
      $scope.normalQueue.push(song)
      var currentlyPlaying = currentlyPlayingIndex()
      // if (currentlyPlaying == $scope.queue.length-1){
      //   $scope.queue.push(song)
      // }else{
      var index = _.random(currentlyPlaying+1, $scope.queue.length)
      $scope.queue.splice(index, 0, song)
      // }

    }else{
      $scope.queue.push(song)
    }
  })

  function current() {
    return songAt(currentlyPlayingIndex())
  }

  function advance() {
    var currentlyPlaying = currentlyPlayingIndex()

    if (currentlyPlaying === null && indexInQueue(0)) {
      songAt(0).playing = true
      return songAt(0)
    }

    if (currentlyPlaying !== null) {
      songAt(currentlyPlaying).playing = false
    }

    if (indexInQueue(currentlyPlaying + 1)) {
      songAt(currentlyPlaying + 1).playing = true
    }else if ($scope.repeatQueue) {
      songAt(0).playing = true
      return songAt(0)
    }
    return songAt(currentlyPlayingIndex())
  }

  function indexInQueue(i) {
    return i < $scope.queue.length && i >= 0
  }

  function songAt(index) {
    return $scope.queue[index]
  }

  function currentlyPlayingIndex() {
    for (var i = 0; i < $scope.queue.length; i++) {
      if ($scope.queue[i].playing) {
        return i
      }
    }
    return null
  }
}])

app.controller('PlayerController',  ['$scope','$window', 'Deejay', function ($scope, $window, Deejay) {
  $scope.play = function() {
    Deejay.playSong()
  }

  $scope.pause = function() {
    Deejay.pauseSong()
  }

  $scope.forward = function(){
    Deejay.skipSong()
  }

  $scope.stop = function(){
    Deejay.stopSong()
  }

  $scope.seekTo = function(event){
    Deejay.seekTo(event.offsetX/angular.element($window).width())
  }

  $scope.playing = Deejay.getIsPlaying

  $scope.currentSong = Deejay.getCurrentSong

  message.on('song-paused-from-youtube-player', function() {
    $scope.$apply() // only way to invoke update that I can think of at the moment.
  })

  message.on('song-played-from-youtube-player', function() {
    $scope.$apply() //ditto
  })

  message.on('song-progress', function(progress) {
    if ($scope.playing) updateProgress(progress, true)
  })

  function updateProgress(progress, animate) {
    var lookahead = animate ? 1 : 0
    var fraction = (progress.position + lookahead) / progress.total
    $('.scrubber-fill').css('transition', animate ? '1s linear' : '0s')
    $('.scrubber-fill').css('transform', 'scaleX('+fraction+')')
  }
}])

</script>
</body>
</html>
