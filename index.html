<!DOCTYPE html>
<html>
  <head>
    <title>Oath Structure</title>
    <style type="text/css" rel="stylesheet">
      iframe {
        position: absolute;
        top: -1000px;
      }

      .queue-item {
        padding: 5px;
        border-radius: 5px;
        border: 1px solid #aaa;
        margin-top: 2px;
        margin-bottom: 2px;
      }

      .queue-item.playing {
        background-color: #ffd;
      }
    </style>
  </head>
  <body>
    <button id="pause">Pause</button>
    <button id="play">Play</button>
    <div id="queue-container"></div>


    <script src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      "use strict";

      class Player {
        constructor(options) {
          var player = this
          this.container = options.container
          this.playButton = options.play
          this.pauseButton = options.pause
          this.queue = options.queue

          var playerElementId = 'player-' + Player.instanceCount
          $('<div>').attr('id', playerElementId).appendTo($('body'))

          this.youtubePlayer = new YT.Player(
            playerElementId,
            {
              height: '390',
              width: '640',
              videoId: this.queue.current().id(),
              events: {
                'onReady': function() { player.onReady() },
                'onStateChange': function(event) { player.onStateChange(event) }
              }
            }
          )

          this.playButton.show()
          this.pauseButton.hide()
        }

        onReady() {
          console.log('ready!')
          var player = this;

          this.playButton.click(function() {
            player.playButton.hide()
            player.pauseButton.show()
            player.youtubePlayer.playVideo()
          })

          this.pauseButton.click(function() {
            player.pauseButton.hide()
            player.playButton.show()
            player.youtubePlayer.pauseVideo()
          })
        }

        onStateChange(event) {
          console.log('changed to: '+event.data)
          if (event.data === YT.PlayerState.ENDED) {
            this.queue.advance()
            this.youtubePlayer.cueVideoById({videoId: this.queue.current().id()})
            this.youtubePlayer.playVideo()
          }
        }
      }

      Player.instanceCount = 0;

      function EventDispatcher() {
        var listeners = {}

        this.fire = function(event, data) {
          if (!listeners[event]) return
          for (var listener of listeners[event]) {
            listener(data)
          }
        }

        this.on = function(event, callback) {
          if (!listeners[event]) listeners[event] = []
          listeners[event].push(callback)
        }
      }

      function VideoQueue() {
        var items = [],
            current = 0,
            events = new EventDispatcher()

        function Item(video) {
          var current = false,
              events = new EventDispatcher()

          this.setCurrent = function(value) {
            current = value
            events.fire('changed')
          }

          this.isCurrent = function() {
            return current
          }

          this.video = function() {
            return video
          }

          this.id = function() {
            return video.getId()
          }

          this.events = function() {
            return events
          }
        }

        this.add = function(video) {
          var item = new Item(video)
          items.push(item)
          if (items.length === 1) item.setCurrent(true)
          events.fire('added', item)
          return this
        }

        this.current = function(video) {
          return items[current]
        }

        this.advance = function() {
          items[current++].setCurrent(false)
          items[current].setCurrent(true)
          return this
        }

        this.events = function() {
          return events
        }

        this.items = function() {
          return items
        }
      }

      function VideoQueueView(queue, $container) {
        var $queue = $('<div class="queue">')

        for (var item of queue.items()) {
          new VideoQueueItemView(item).appendTo($queue)
        }

        queue.events().on('added', function(item) {
          new VideoQueueItemView(item).appendTo($queue)
        })

        $queue.appendTo($container)
      }

      function VideoQueueItemView(item) {
        var $e = $('<div class="queue-item">'),
            thisItemView = this

        item.events().on('changed', function() { thisItemView.render() })

        this.render = function() {
          $e.text(item.id())
          $e.toggleClass('playing', item.isCurrent())
          return this
        }

        this.appendTo = function(parent) {
          this.render()
          $e.appendTo(parent)
          return this
        }
      }

      class Video {
        constructor(id) {
          this.id = id
        }

        getId() {
          return this.id
        }
      }

      class NullVideo extends Video {
        constructor() {
          super(null)
        }
      }

      var g = {}

      function onYouTubeIframeAPIReady() {
        var queue = g.queue = new VideoQueue()
          .add(new Video('au3-hk-pXsM'))
          .add(new Video('HsUgZANvAbU'))
          .add(new Video('5ARw19AnLK4'))

        new VideoQueueView(queue, $('#queue-container'))

        g.player = new Player({
          container: $('body'),
          play: $('#play'),
          pause: $('#pause'),
          queue: queue
        });
      }
    </script>
  </body>
</html>
