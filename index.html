<!DOCTYPE html>
<html>
  <head>
    <title>Oath Structure</title>
    <style type="text/css" rel="stylesheet">
      /*iframe {*/
      /*  position: absolute;*/
      /*  top: -1000px;*/
      /*}*/

      .queue-item {
        padding: 5px;
        border-radius: 5px;
        border: 1px solid #aaa;
        margin-top: 2px;
        margin-bottom: 2px;
      }

      .queue-item.playing {
        background-color: #ffd;
      }

      [ng-cloak], [data-ng-cloak], [x-ng-cloak], .ng-cloak, .x-ng-cloak {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="player-container">
      <button id="pause">Pause</button>
      <button id="play">Play</button>
      <div id="youtube-player"></div>
    </div>
    <div id="app-container" ng-app="OathStructure">
      <div class="queue-container" ng-controller="QueueController">
        <div class="search">
          <input type="text" ng-model="searchQuery">
        </div>
        <ol class="queue" ng-cloak>
          <li ng-repeat="song in queue | filter:searchQuery" class="queue-item">
            {{ song.title }}
          </li>
        </ol>
        <input type="text" ng-model="addition">
        <button ng-click="enqueue(addition)">Add</button>
      </div>
    </div>

    <script src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
    <script src="/angular.min.js" type="text/javascript"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      "use strict";

      function Deejay() {
        var div = document.createElement('div')
        div.setAttribute('id', 'youtube-player-1')
        document.getElementById('player-container').appendChild(div)

        div = document.createElement('div')
        div.setAttribute('id', 'youtube-player-2')
        document.getElementById('player-container').appendChild(div)

        var players = []
        players.push(new YT.Player(
          'youtube-player-1',
          {
            height: '195',
            width: '320',
            videoId: 'au3-hk-pXsM',
            playerVars: { rel: 0, controls: 0 },
            events: {
              'onReady': readyPlayer1,
              'onStateChange': stateChangePlayer1
            }
          }
        ))

        players.push(new YT.Player(
          'youtube-player-2',
          {
            height: '195',
            width: '320',
            videoId: 'au3-hk-pXsM',
            playerVars: { rel: 0, controls: 0 },
            events: {
              'onReady': readyPlayer2,
              'onStateChange': stateChangePlayer2
            }
          }
        ))

        message.on('play-now', function(videoId) {
          stop()
          if (inactivePlayer().getVideoData()['video_id'] === videoId) {
            swapActivePlayer()
          } else {
            activePlayer().cueVideoById(videoId)
          }
          play()
        })

        message.on('play-next', function(videoId) {
          inactivePlayer().cueVideoById(videoId)
          // hack: start playing the video and immediately pause when the
          // state changes from BUFFERING to PLAYING. This will cause the
          // video to buffer in the background.
          // http://stackoverflow.com/questions/8088245/preloading-a-youtube-embed
          inactivePlayer().playVideo()
        })

        message.on('resume', function() {
          play()
        })

        message.on('pause', function() {
          stop()
        })

        function activePlayerStateChanged(event) {
          if (event.data === YT.PlayerState.ENDED) {
            message.send('song-complete')
          }
        }

        function inactivePlayerStateChanged(event) {
          if (event.data === YT.PlayerState.PLAYING) {
            inactivePlayer().pauseVideo()
          }
        }

        function stop(hammerTime) {
          activePlayer().pauseVideo()
        }

        function play() {
          activePlayer().playVideo()
        }

        var activePlayerIndex = 0
        function activePlayer() {
          return players[activePlayerIndex]
        }

        function inactivePlayer() {
          return players[+!activePlayerIndex]
        }

        function swapActivePlayer() {
          activePlayerIndex = +!activePlayerIndex
        }

        var readyCount = 0
        function readyPlayer1() {
          readyCount++
          ready()
        }

        function readyPlayer2() {
          readyCount++
          ready()
        }

        function ready() {
          if (readyCount === 2) {

          }
        }

        function stateChangePlayer1(event) {
          if (!activePlayerIndex) {
            activePlayerStateChanged(event)
          } else {
            inactivePlayerStateChanged(event)
          }
        }

        function stateChangePlayer2(event) {
          if (activePlayerIndex) {
            activePlayerStateChanged(event)
          } else {
            inactivePlayerStateChanged(event)
          }
        }

        setInterval(function() {
          console.log("active: " + activePlayer().getVideoData()['title'] + " " + (activePlayer().getVideoLoadedFraction() * 100 | 0))
          console.log("inactive: " + inactivePlayer().getVideoData()['title'] + " " + (inactivePlayer().getVideoLoadedFraction() * 100 | 0))
        }, 1000)
      }

      var global = {}
      function onYouTubeIframeAPIReady() {

        global.deejay = new Deejay()

        var playButton = $('#play')
        playButton.click(function() {
          message.send('resume')
          playButton.hide()
          pauseButton.show()
        })

        var pauseButton = $('#pause')
        pauseButton.click(function() {
          message.send('pause')
          pauseButton.hide()
          playButton.show()
        })

        pauseButton.hide()
      }

      var message = (function() {
        var handlers = {}
        var message = {}

        message.on = function(message, handler) {
          if (!handlers[message]) handlers[message] = []
          handlers[message].push(handler)
          console.log('there are now ' + handlers[message].length + ' handlers for "'+message+'".')
        }

        message.send = function() {
          var message = arguments[0]
          for (var handler of handlers[message]) {
            handler.call(null, arguments[1])
          }
        }

        return message
      })();

      var os = angular.module('OathStructure', [])

      os.controller('QueueController', function($scope) {

        var current = 0

        message.on('song-complete', requestNextSong)
        function requestNextSong() {
          $scope.advance()
          message.send("play-now", queue[current].id)
          message.send("play-next", queue[current + 1].id)
          $scope.$apply()
        }

        var queue = $scope.queue = [
          { title: 'Magical Trevor #1', id: 'au3-hk-pXsM' },
          { title: 'Magical Trevor #2', id: 'HsUgZANvAbU' },
          { title: 'Video Game Music Compilation', id: '5ARw19AnLK4'  }
        ]

        $scope.enqueue = function(title) {
          $scope.queue.push({title: title})
          $scope.addition = ''
        }

        $scope.advance = function() {
          current++
        }
      })
    </script>
  </body>
</html>
