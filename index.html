<!DOCTYPE html>
<html>
  <head>
    <title>Oath Structure</title>
    <style type="text/css" rel="stylesheet">
      iframe {
        position: absolute;
        top: -1000px;
      }

      .queue-item {
        padding: 5px;
        border-radius: 5px;
        border: 1px solid #aaa;
        margin-top: 2px;
        margin-bottom: 2px;
      }

      .button {
        cursor: pointer;
      }

      .player-controls .button {
        display: none;
      }

      .player-controls .actionable.button {
        display: inline;
      }

      .queue-item.playing {
        background-color: #ffd;
      }

      [ng-cloak], [data-ng-cloak], [x-ng-cloak], .ng-cloak, .x-ng-cloak {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="player-container">
      <div id="youtube-player"></div>
    </div>

    <div id="app-container" ng-app="OathStructure">
      <div class="player-controls" ng-controller="PlayerController">
        <div ng-hide="!isReady()">
          <i id="pause"
             class="fa fa-pause fa-3x button"
             ng-class="{actionable: isPlaying()}"
             ng-click="pause()"
             ></i>
          <i id="play"
             class="fa fa-play fa-3x button"
             ng-class="{actionable: isStopped()}"
             ng-click="play()"
             ></i>
          <i id="resume"
             class="fa fa-play fa-3x button"
             ng-class="{actionable: isPaused()}"
             ng-click="resume()"
             ></i>
        </div>
      </div>
      <div class="queue-container" ng-controller="QueueController">

        <ol class="queue" ng-cloak>
          <li class="queue-item"
              ng-repeat="song in queue() track by song.listId"
              ng-class="{playing: isPlaying(song.listId)}"
              ng-click="jumpTo(song.listId)"
              >
            {{ song.title }}
          </li>
        </ol>
        <input type="text" ng-model="addition">
        <button ng-click="enqueue(addition)">Add</button>
      </div>
      <div class="library-container">
        <!-- <div class="search">
          <input type="text" ng-model="searchQuery">
        </div>-->
        <ul class="library" ng-cloak>
           <li class="library-item"
               ng-repeat="song in library | filter:searchQuery">
              {{ song.title }}
           </li>
        </ul>
      </div>
    </div>

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <script src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
    <script src="/angular.min.js" type="text/javascript"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="message.js"></script>
    <script src="linked_list.js"></script>
    <script src="queue_controller.js"></script>
    <script>
      "use strict";

      function Deejay() {
        var div = document.createElement('div')
        div.setAttribute('id', 'youtube-player-1')
        document.getElementById('player-container').appendChild(div)

        div = document.createElement('div')
        div.setAttribute('id', 'youtube-player-2')
        document.getElementById('player-container').appendChild(div)

        var players = []
        players.push(new YT.Player(
          'youtube-player-1',
          {
            height: '195',
            width: '320',
            videoId: 'au3-hk-pXsM',
            playerVars: { rel: 0, controls: 0 },
            events: {
              'onReady': readyPlayer1,
              'onStateChange': stateChangePlayer1
            }
          }
        ))

        players.push(new YT.Player(
          'youtube-player-2',
          {
            height: '195',
            width: '320',
            videoId: 'au3-hk-pXsM',
            playerVars: { rel: 0, controls: 0 },
            events: {
              'onReady': readyPlayer2,
              'onStateChange': stateChangePlayer2
            }
          }
        ))

        message.on('play-now', function(request) {
          var videoId = request.mediaId()
          stop()
          var cued = inactivePlayer().getVideoData()
          if (cued && cued['video_id'] === videoId) {
            swapActivePlayer()
          } else {
            activePlayer().cueVideoById(videoId)
          }
          play()
        })

        message.on('play-next', function(videoId) {
          inactivePlayer().cueVideoById(videoId)
          // hack: start playing the video and immediately pause when the
          // state changes from BUFFERING to PLAYING. This will cause the
          // video to buffer in the background.
          // http://stackoverflow.com/questions/8088245/preloading-a-youtube-embed
          inactivePlayer().playVideo()
        })

        message.on('resume', function() {
          play()
        })

        message.on('pause', function() {
          stop()
        })

        function activePlayerStateChanged(event) {
          if (event.data === YT.PlayerState.ENDED) {
            message.send('song-complete')
          }
        }

        function inactivePlayerStateChanged(event) {
          if (event.data === YT.PlayerState.PLAYING) {
            inactivePlayer().pauseVideo()
          }
        }

        function stop(hammerTime) {
          activePlayer().pauseVideo()
        }

        function play() {
          activePlayer().playVideo()
        }

        var activePlayerIndex = 0
        function activePlayer() {
          return players[activePlayerIndex]
        }

        function inactivePlayer() {
          return players[+!activePlayerIndex]
        }

        function swapActivePlayer() {
          activePlayerIndex = +!activePlayerIndex
        }

        var readyCount = 0
        function readyPlayer1() {
          readyCount++
          ready()
        }

        function readyPlayer2() {
          readyCount++
          ready()
        }

        function ready() {
          if (readyCount === 2) {
            message.send('deejay-ready')
          }
        }

        function stateChangePlayer1(event) {
          if (!activePlayerIndex) {
            activePlayerStateChanged(event)
          } else {
            inactivePlayerStateChanged(event)
          }
        }

        function stateChangePlayer2(event) {
          if (activePlayerIndex) {
            activePlayerStateChanged(event)
          } else {
            inactivePlayerStateChanged(event)
          }
        }
      }

      var global = {}
      function onYouTubeIframeAPIReady() {
        global.deejay = new Deejay()
      }

      //var message = (function() {
      //  var handlers = {}
      //  var message = {}
      //
      //  message.on = function(message, handler) {
      //    if (!handlers[message]) handlers[message] = []
      //    handlers[message].push(handler)
      //    console.log('there are now ' + handlers[message].length + ' handlers for "'+message+'".')
      //  }
      //
      //  message.send = function() {
      //    var message = arguments[0]
      //    if (handlers[message]) {
      //      for (var handler of handlers[message]) {
      //        handler.call(null, arguments[1])
      //      }
      //    }
      //  }
      //
      //  return message
      //})();

      var app = angular.module('OathStructure', [])

      app.controller('QueueController', QueueController)

      app.controller('PlayerController', function($scope) {
        var STOPPED = 0,
            PLAYING = 1,
            PAUSED  = 2

        $scope.state = STOPPED

        var ready = false
        $scope.isReady = function() {
          return ready
        }

        $scope.play = function() {
          if ($scope.state === STOPPED) {
            $scope.state = PLAYING
            message.send('play')
          }
        }

        $scope.pause = function() {
          if ($scope.isPlaying()) {
            $scope.state = PAUSED
            message.send('pause')
          }
        }

        $scope.resume = function() {
          if ($scope.state === PAUSED) {
            $scope.state = PLAYING
            message.send('resume')
          }
        }

        $scope.stop = function() {
          if ($scope.state !== STOPPED) {
            $scope.state = STOPPED
            message.send('stop-playing')
          }
        }

        $scope.isPlaying = function() {
          return $scope.state === PLAYING
        }

        $scope.isPaused = function() {
          return $scope.state === PAUSED
        }

        $scope.isStopped = function() {
          return $scope.state === STOPPED
        }

        message.on('play-now', $scope.play)
        message.on('play-now', $scope.resume)
        message.on('deejay-ready', function() {
          ready = true
          $scope.$apply()
        })
      })
    </script>
  </body>
</html>
